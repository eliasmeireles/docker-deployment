# Use the official Golang image to build the Go application
FROM golang:1.22 AS builder

# Set the Current Working Directory inside the container
WORKDIR /app

COPY go.mod go.sum ./

RUN go mod download

COPY src ./src/
COPY main.go .

RUN CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o deployment

# Create a new stage to minimize the image size
FROM ubuntu:24.04

# Install necessary packages for the runtime environment
RUN apt-get update && \
    apt-get install -y libyaml-dev net-tools curl vim && \
    apt-get clean

# Copy the binary from the builder stage
COPY --from=builder /app/deployment /usr/local/bin/deployment

# Create a directory for the configuration file
RUN mkdir -p /opt

RUN mkdir -p /etc/docker/certs.d

# Set the entry point to the Go binary
ENTRYPOINT ["/usr/local/bin/deployment"]

# Set the default argument to the configuration file path
CMD ["/opt/config.yml"]
